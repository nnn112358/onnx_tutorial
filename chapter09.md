# 第9章 トラブルシューティングと検証のワークフロー
### 9.1 よくあるエラーの理解
ONNXを扱う際によく遭遇するエラーを事前に知っておくと、原因を切り分けやすくなります。代表的なのは次の3つです。

- `InvalidGraph`：グラフ構造が壊れているか、入力・出力の定義が不足している場合に発生します。変換時に仕様に合わないTensorShapeが生成されたときにも起こるため、`onnx.checker.check_model`でバリデーションを行いましょう。
- 入力形状ミスマッチ：推論時に渡したテンソルの形状がモデルと一致しないと、`InvalidArgument`や`RuntimeException`が出ます。Chapter 4で紹介した方法で`model.graph.input`を確認し、必要があれば前処理で形状を合わせます。
- 演算子未対応：ONNX Runtimeが対応していない演算子を含むモデルを読み込んだときに発生します。`session.get_modelmeta().custom_metadata_map`などでヒントが得られることもあるので、ログを丁寧に確認しましょう。

### 9.2 デバッグの手順
変換後のモデルが期待通りに動かない場合、まずは元のフレームワークとONNXモデルで同じ入力を与え、出力を比較します。差が出たら、その時点までの中間出力を順番に追う方法が有効です。PyTorchではフック機能（`register_forward_hook`）を使って中間層の出力を取得できます。

ONNX Runtimeでは`RunOptions`の`log_severity_level`を`0`に設定すると詳細ログが出力され、どのノードで値がおかしいか推測しやすくなります。ONNX Runtimeの最新バージョンでは「デバッグノード」を挿入する機能が提供されており、特定ノードの出力を保存することも可能です。

### 9.3 品質を担保するテスト
モデル変換と最適化は繰り返し行う作業なので、自動テストを用意すると品質を維持しやすくなります。Pythonでは`pytest`を使って「サンプル入力を与えた結果が期待値から一定範囲内に収まるか」をチェックするテストを書くとよいでしょう。

CI（継続的インテグレーション）環境にONNX Runtimeとテストスクリプトを組み込み、モデル更新のたびに自動で検証するのがおすすめです。GitHub Actionsでは、`actions/setup-python`でPython環境を用意し、`pip install onnxruntime`を実行してテストを走らせるワークフローがよく利用されています。CIで異常が検知されたら開発者に通知が届くようにして、問題を早期に発見できる体制を整えましょう。

## 図のアイデア
- images/ch09_debug_flow.png — トラブルシューティングの意思決定フロー図

## 演習
1. 変換後モデルで発生したエラーを想定し、原因切り分けの手順書（チェックリスト形式）を作成する
2. CIでONNX推論テストを自動化するワークフローを設計し、実行コマンドを列挙する
